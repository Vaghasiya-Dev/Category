<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - RBAC System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: linear-gradient(135deg, #5b7bff 0%, #7f53ac 50%, #c86dd7 100%);
            --card: #ffffff;
            --text: #1f2933;
            --muted: #6b7280;
            --primary: #5b7bff;
            --shadow: 0 18px 54px rgba(0,0,0,0.22);
            --radius: 16px;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            padding: 28px;
        }
        .shell {
            max-width: 1250px;
            margin: 0 auto;
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 28px;
            color: var(--text);
        }
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 14px; 
            margin-bottom: 28px; 
            flex-wrap: wrap;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        header h1 { font-size: 2rem; display: flex; align-items: center; gap: 10px; }
        .user-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(91,123,255,0.1), rgba(127,83,172,0.1));
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
        }
        .nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        a.btn, button.btn {
            text-decoration: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        a.btn.secondary {
            background: #f3f4f6;
            color: var(--text);
        }
        a.btn.secondary:hover { background: #e5e7eb; }
        a.btn.logout { background: var(--danger); color: white; }
        a.btn.logout:hover { background: #dc2626; }
        
        .tabs { 
            display: flex; 
            gap: 4px; 
            margin-bottom: 24px; 
            border-bottom: 2px solid #e5e7eb; 
        }
        .tab-btn { 
            padding: 12px 20px; 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            color: var(--muted); 
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message { 
            padding: 14px 16px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            display: none;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.success { background: #d1fae5; color: #065f46; border-left: 4px solid var(--success); }
        .message.error { background: #fee2e2; color: #991b1b; border-left: 4px solid var(--danger); }
        .message.info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .section-header h3 { font-size: 1.3rem; }
        .section-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #5b7bff, #7f53ac);
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(91,123,255,0.3);
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        .table { 
            width: 100%; 
            border-collapse: collapse;
        }
        .table thead {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        }
        .table th { 
            padding: 14px 12px; 
            text-align: left; 
            font-weight: 700;
            color: var(--text);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .table td { 
            padding: 14px 12px; 
            border-top: 1px solid #e5e7eb; 
        }
        .table tbody tr { transition: background 0.2s ease; }
        .table tbody tr:hover { background: #f8fafc; }
        
        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .role-badge.super_admin { background: #fef3c7; color: #92400e; }
        .role-badge.admin { background: #dbeafe; color: #1e40af; }
        .role-badge.emp { background: #e0e7ff; color: #3730a3; }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-badge.active { background: #d1fae5; color: #065f46; }
        .status-badge.inactive { background: #fee2e2; color: #991b1b; }
        
        .action-btns {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-edit { background: #dbeafe; color: #1e40af; }
        .btn-edit:hover { background: #bfdbfe; }
        .btn-delete { background: #fee2e2; color: #991b1b; }
        .btn-delete:hover { background: #fecaca; }
        .btn-sm:disabled { opacity: 0.4; cursor: not-allowed; }
        
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 16px; 
            margin-bottom: 24px;
        }
        .stat-box { 
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid #e5e7eb; 
            padding: 20px; 
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #5b7bff, #7f53ac);
        }
        .stat-box h4 { 
            font-size: 0.9rem; 
            color: var(--muted); 
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-box .number { 
            font-size: 2.2rem; 
            font-weight: 700; 
            background: linear-gradient(135deg, #5b7bff, #7f53ac);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .loading { 
            text-align: center; 
            padding: 60px 20px; 
            color: var(--muted);
        }
        .loading::after {
            content: '‚è≥';
            font-size: 2rem;
            display: block;
            margin-top: 10px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: var(--muted);
        }
        .empty-state h3 { 
            font-size: 1.2rem; 
            margin-bottom: 8px;
            color: var(--text);
        }
        .stats-title {
            margin-bottom: 20px;
        }
        
        /* Modal Styles */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.2s ease;
        }
        .modal-content { 
            background-color: var(--card); 
            margin: 3% auto; 
            padding: 0; 
            border-radius: var(--radius); 
            max-width: 600px; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.35);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header { 
            padding: 24px 28px; 
            border-bottom: 1px solid #e5e7eb; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        }
        .modal-header h2 { font-size: 1.5rem; font-weight: 700; }
        .close-btn { 
            font-size: 28px; 
            font-weight: bold; 
            color: var(--muted); 
            cursor: pointer; 
            border: none; 
            background: none;
            transition: color 0.2s ease;
        }
        .close-btn:hover { color: var(--text); }
        .modal-body { padding: 28px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 8px;
            color: var(--text);
        }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            font-family: inherit; 
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .form-group input:focus, .form-group select:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(91,123,255,0.1);
        }
        .form-help-text { 
            color: var(--muted); 
            font-size: 0.85rem; 
            margin-top: 6px;
        }
        .modal-actions { 
            display: flex; 
            gap: 12px; 
            justify-content: flex-end; 
            margin-top: 28px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        .modal-btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .modal-btn.primary { 
            background: linear-gradient(135deg, #5b7bff, #7f53ac); 
            color: white; 
        }
        .modal-btn.primary:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(91,123,255,0.3);
        }
        .modal-btn.secondary { background: #f3f4f6; color: var(--text); }
        .modal-btn.secondary:hover { background: #e5e7eb; }
        
        @media (max-width: 768px) {
            .shell { padding: 20px; }
            header h1 { font-size: 1.5rem; }
            .stats { grid-template-columns: 1fr; }
            .table-container { overflow-x: scroll; }
        }
    </style>
</head>
<body>
    <div class="shell">
        <header>
            <div>
                <h1>
                    üë§ Admin Panel
                    <span class="user-badge" id="userRoleBadge">Loading...</span>
                </h1>
            </div>
            <div class="nav">
                <a href="/dashboard" class="btn secondary">‚Üê Dashboard</a>
                <a href="/" class="btn logout" onclick="logout()">Logout</a>
            </div>
        </header>

        <div class="message" id="message"></div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('users')">üë• Users</button>
            <button class="tab-btn" onclick="switchTab('audiences')">üéØ Audiences</button>
            <button class="tab-btn" onclick="switchTab('stats')">üìä Statistics</button>
        </div>

        <!-- Users Tab -->
        <div id="users" class="tab-content active">
            <div class="section-header">
                <h3>User Management</h3>
                <div class="section-actions" id="userActions">
                    <!-- Dynamically populated based on permissions -->
                </div>
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr><td colspan="6" class="loading">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Audiences Tab -->
        <div id="audiences" class="tab-content">
            <div class="section-header">
                <h3>Audience Management</h3>
                <div class="section-actions">
                    <button class="btn-primary" onclick="openCreateAudienceModal()" id="btnCreateAudience">
                        ‚ûï Create Audience
                    </button>
                </div>
            </div>
            <div id="audiencesContainer">
                <div class="loading">Loading audiences...</div>
            </div>
        </div>

        <!-- Statistics Tab -->
        <div id="stats" class="tab-content">
            <h3 class="stats-title">System Statistics</h3>
            <div class="stats" id="statsContainer">
                <div class="loading">Loading statistics...</div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New User</h2>
                <button class="close-btn" onclick="closeModal('createUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="form-group">
                        <label for="newUsername">Username *</label>
                        <input type="text" id="newUsername" required placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label for="newEmail">Email *</label>
                        <input type="email" id="newEmail" required placeholder="user@example.com">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Password *</label>
                        <input type="password" id="newPassword" required placeholder="Minimum 6 characters">
                        <div class="form-help-text">Password must be at least 6 characters</div>
                    </div>
                    <div class="form-group">
                        <label for="newRole">Role *</label>
                        <select id="newRole" required>
                            <option value="">-- Select Role --</option>
                            <option value="emp">Employee</option>
                            <option value="admin">Administrator</option>
                        </select>
                        <div class="form-help-text">You can only create roles at or below your level</div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="modal-btn secondary" onclick="closeModal('createUserModal')">Cancel</button>
                        <button type="submit" class="modal-btn primary">Create User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentUserRole = '';
        let permissions = {};
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadPermissions();
            await loadUsers();
            await loadAudiences();
            await loadStats();
        });
        
        async function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error('Authentication failed');
                }
                
                const data = await response.json();
                currentUserRole = data.user.role;
                
                document.getElementById('userRoleBadge').textContent = 
                    `${getRoleIcon(currentUserRole)} ${getRoleLabel(currentUserRole)}`;
                
                // Check if user has access to admin panel
                if (currentUserRole === 'emp') {
                    showMessage('You do not have permission to access this page', 'error');
                    setTimeout(() => window.location.href = '/dashboard', 2000);
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.clear();
                window.location.href = '/login';
            }
        }
        
        async function loadPermissions() {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch('/admin-handler/capabilities', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Failed to load permissions:', response.status, errorData.message);
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    permissions = data.capabilities;
                    updateUIBasedOnPermissions();
                }
            } catch (error) {
                console.error('Failed to load permissions:', error);
            }
        }
        
        function updateUIBasedOnPermissions() {
            const actionsHtml = [];
            
            // Add create employee button if allowed
            if (permissions.can_create_emp) {
                actionsHtml.push('<button class="btn-primary" onclick="openCreateUserModal(\'emp\')">‚ûï Create Employee</button>');
            }
            
            // Add create admin button if allowed (only super_admin)
            if (permissions.can_create_admin) {
                actionsHtml.push('<button class="btn-primary" onclick="openCreateUserModal(\'admin\')">‚ûï Create Admin</button>');
            }
            
            document.getElementById('userActions').innerHTML = actionsHtml.join('');
            
            // Update the role dropdown in create user modal based on permissions
            updateRoleDropdown();
        }
        
        function updateRoleDropdown() {
            const roleSelect = document.getElementById('newRole');
            const options = ['<option value="">-- Select Role --</option>'];
            
            if (permissions.can_create_emp) {
                options.push('<option value="emp">Employee</option>');
            }
            
            if (permissions.can_create_admin) {
                options.push('<option value="admin">Administrator</option>');
            }
            
            roleSelect.innerHTML = options.join('');
        }
        
        async function loadUsers() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('userTableBody');
            
            try {
                const response = await fetch('/api/users/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (data.success && data.users) {
                    if (data.users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><h3>No users found</h3><p>Create your first user to get started</p></td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = data.users.map(user => {
                        const canEdit = canEditUser(user.role);
                        const canDelete = canDeleteUser(user.role);
                        
                        return `
                        <tr>
                            <td><strong>${escapeHtml(user.username)}</strong></td>
                            <td>${escapeHtml(user.email)}</td>
                            <td><span class="role-badge ${user.role}">${getRoleLabel(user.role)}</span></td>
                            <td><span class="status-badge ${user.status || 'active'}">${user.status || 'active'}</span></td>
                            <td>${formatDate(user.created_at)}</td>
                            <td>
                                <div class="action-btns">
                                    ${canEdit ? 
                                        `<button class="btn-sm btn-edit" onclick="editUser('${user.user_id}', '${user.role}')">‚úèÔ∏è Edit</button>` : 
                                        ''}
                                    ${canDelete ? 
                                        `<button class="btn-sm btn-delete" onclick="deleteUser('${user.user_id}', '${user.role}')">üóëÔ∏è Delete</button>` : 
                                        ''}
                                    ${!canEdit && !canDelete ? '<span style="color: var(--muted);">No actions</span>' : ''}
                                </div>
                            </td>
                        </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><h3>Failed to load users</h3></td></tr>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><h3>Error loading users</h3></td></tr>';
            }
        }
        
        async function loadAudiences() {
            const token = localStorage.getItem('access_token');
            const container = document.getElementById('audiencesContainer');
            
            try {
                const response = await fetch('/api/audiences/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                const totalAudiences = data.total !== undefined
                    ? data.total
                    : (data.audiences ? data.audiences.length : 0);
                
                if (data.success) {
                    container.innerHTML = `
                        <div class="stats">
                            <div class="stat-box">
                                <h4>Total Audiences</h4>
                                <div class="number">${totalAudiences}</div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>Failed to load audiences</h3></div>';
                }
            } catch (error) {
                console.error('Error loading audiences:', error);
                container.innerHTML = '<div class="empty-state"><h3>Error loading audiences</h3></div>';
            }
        }
        
        async function loadStats() {
            const token = localStorage.getItem('access_token');
            const container = document.getElementById('statsContainer');
            
            try {
                const usersResponse = await fetch('/api/users/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const audiencesResponse = await fetch('/api/audiences/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const usersData = await usersResponse.json();
                const audiencesData = await audiencesResponse.json();
                
                const totalUsers = usersData.users ? usersData.users.length : 0;
                const totalAudiences = audiencesData.total !== undefined
                    ? audiencesData.total
                    : (audiencesData.audiences ? audiencesData.audiences.length : 0);
                
                const empCount = usersData.users ? usersData.users.filter(u => u.role === 'emp').length : 0;
                const adminCount = usersData.users ? usersData.users.filter(u => u.role === 'admin').length : 0;
                const superAdminCount = usersData.users ? usersData.users.filter(u => u.role === 'super_admin').length : 0;
                
                container.innerHTML = `
                    <div class="stat-box">
                        <h4>Total Users</h4>
                        <div class="number">${totalUsers}</div>
                    </div>
                    <div class="stat-box">
                        <h4>Employees</h4>
                        <div class="number">${empCount}</div>
                    </div>
                    <div class="stat-box">
                        <h4>Administrators</h4>
                        <div class="number">${adminCount}</div>
                    </div>
                    <div class="stat-box">
                        <h4>Super Admins</h4>
                        <div class="number">${superAdminCount}</div>
                    </div>
                    <div class="stat-box">
                        <h4>Total Audiences</h4>
                        <div class="number">${totalAudiences}</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
                container.innerHTML = '<div class="empty-state"><h3>Error loading statistics</h3></div>';
            }
        }
        
        function openCreateUserModal(role = '') {
            document.getElementById('createUserModal').style.display = 'block';
            document.getElementById('createUserForm').reset();
            if (role) {
                document.getElementById('newRole').value = role;
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;
            
            // Validate role selection
            if (!role) {
                showMessage('Please select a role', 'error');
                return;
            }
            
            // Check if user has permission to create this role
            if (role === 'emp' && !permissions.can_create_emp) {
                showMessage('You do not have permission to create employees', 'error');
                return;
            }
            if (role === 'admin' && !permissions.can_create_admin) {
                showMessage('You do not have permission to create administrators', 'error');
                return;
            }
            
            const token = localStorage.getItem('access_token');
            const endpoint = role === 'admin' ? '/api/users/admin' : '/api/users/emp';
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`${getRoleLabel(role)} ${username} created successfully!`, 'success');
                    closeModal('createUserModal');
                    await loadUsers();
                    await loadStats();
                } else {
                    showMessage(data.message || 'Failed to create user', 'error');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                showMessage('An error occurred while creating user', 'error');
            }
        });
        
        async function deleteUser(userId, role) {
            // Check if user has permission to delete this role
            if (!canDeleteUser(role)) {
                showMessage(`You don't have permission to delete ${getRoleLabel(role)} users`, 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete this ${getRoleLabel(role)} user?`)) return;
            
            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('User deleted successfully', 'success');
                    await loadUsers();
                    await loadStats();
                } else {
                    showMessage(data.message || 'Failed to delete user', 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showMessage('An error occurred while deleting user', 'error');
            }
        }
        
        function canEditUser(targetRole) {
            // Check permissions based on target role
            if (targetRole === 'emp') {
                return permissions.can_edit_emp || false;
            }
            if (targetRole === 'admin') {
                return permissions.can_edit_admin || false;
            }
            if (targetRole === 'super_admin') {
                return false; // Cannot edit super admins
            }
            return false;
        }
        
        function canDeleteUser(targetRole) {
            // Check permissions based on target role
            if (targetRole === 'emp') {
                return permissions.can_delete_emp || false;
            }
            if (targetRole === 'admin') {
                return permissions.can_delete_admin || false;
            }
            if (targetRole === 'super_admin') {
                return false; // Cannot delete super admins
            }
            return false;
        }
        
        async function editUser(userId, userRole) {
            // Check if user has permission to edit this role
            if (!canEditUser(userRole)) {
                showMessage(`You don't have permission to edit ${getRoleLabel(userRole)} users`, 'error');
                return;
            }
            
            // Implementation for edit user (can be expanded)
            showMessage('Edit user functionality - to be implemented', 'info');
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        function showMessage(text, type) {
            const msgEl = document.getElementById('message');
            msgEl.textContent = text;
            msgEl.className = `message ${type}`;
            msgEl.style.display = 'block';
            setTimeout(() => msgEl.style.display = 'none', 5000);
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = '/login';
        }
        
        function getRoleLabel(role) {
            const labels = {
                'super_admin': 'Super Admin',
                'admin': 'Administrator',
                'emp': 'Employee'
            };
            return labels[role] || role;
        }
        
        function getRoleIcon(role) {
            const icons = {
                'super_admin': 'üëë',
                'admin': 'üëî',
                'emp': 'üë§'
            };
            return icons[role] || 'üë§';
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
